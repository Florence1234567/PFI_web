@model IEnumerable<ChatManager.Models.User>

@{
    ViewBag.Title = "ChatRoom";
}



<div style="display: grid; grid-template-columns: 65px auto; align-items: center;">
    <img src="~/favicon.png" style="width: 56px;" />
    <h3>Salle de discussions</h3>
</div>

<div class="main">
    <div style="display: grid; grid-template-columns: 60px auto; column-gap: 10px;">
        <div class="friendsListContainer" id="friendListContainer">
            @foreach (var item in Model)
            {
                if (ChatManager.Models.OnlineUsers.GetSessionUser() != item)
                {
                    <div class="unselectedTarget" title="@item.FirstName @item.LastName" data-user-id="@item.Id">
                        <a href="/Chat/SetMessagedUserId/@item.Id">
                            @Helper.AvatarUser(item, "UserSmallAvatar", true)
                        </a>
                    </div>
                }
            }
        </div>
        <div>
            <div class="messagesPanel" id="messagePanel">
                <div class="messagesHeader">
                    <h4 id="Selected">Sélectionnez un ami.</h4>
                </div>

                <span>
                   
                    @Helper.ParseContent(Session["MessagedUserId"].ToString())
                </span>

                @foreach (var message in ViewBag.Messages)
                {

                    if (message.Sender == (int)Session["MessagedUserId"] || message.Receiver == (int)Session["MessagedUserId"])
                    {

                        if (message.Sender == ChatManager.Models.OnlineUsers.GetSessionUser().Id)
                        {

                            <div class="sentLayout">

                                <div class="sent">
                                    @Helper.ParseContent(message.Message)

                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="receivedLayout">
                                <div class="received">
                                    @Helper.ParseContent(message.Message)

                                </div>
                            </div>

                        }
                    }
                }

            </div>
            <div class="sendMessageLayout">
                <input id="message" class="form-control" style="width:100% !important; max-width:1000px !important;" placeholder="Tapez votre message ici ..." title="Les urls d'image sont prises en compte.">
                <span id="send" class="icon fa fa-paper-plane" title="Envoyer" data-placement="bottom"></span>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
<script defer>
        $("#message").hide();
        $("#send").hide();

        // MESSAGES

        function SendMessage(userId) {
            //sending the message
;            $.ajax({
                url: "/Chat/SendMessage",
                type: "POST",
                data: { id: userId, message: $("#message").val() },
                success: function (response) {
                    console.log("Message sent: " + $("#message").val());
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log("Error sending message: " + errorThrown);
                }
            });
            // Clear the message input
            $("#message").val("");
        }

        function ShowMessages(userId) {
           
             /*$.ajax({
                url: "/Chat/GetMessages",
                type: "GET",
                data: { id: userId },
                success: function (data) {

                    $(".messagesPanel").find(".sentLayout").remove();
                    $(".messagesPanel").find(".receivedLayout").remove();
                    $(".messagesPanel").find(".messageTime").remove();

                    for (var i = 0; i < data.length; i++) {

                        var messageObject = data[i];
                        var message = messageObject.Message.toString();
                        var date = messageObject.Date;

                        // Afficher le temps
                        if (i == 0) {
                            var messageTime = $("<div>").addClass("messageTime");
                            messageTime.text(date);
                            $(".messagesPanel").append(messageTime);
                        }

                        var messageLayout = $("<div>");

                        var messageContainer = $("<div>");
                        messageContainer.attr("title", date);

                        //var messageSpan = $("<span>").addClass("token");
                        //messageSpan.text(message);

                        if (messageObject.Sender == userId) {
                            messageLayout.addClass("receivedLayout");
                            messageContainer.addClass("received");
                            messageContainer.attr("id", "received_" + messageObject.Id);
                        }
                        else {
                            messageLayout.addClass("sentLayout");
                            messageContainer.addClass("sent");
                            messageContainer.attr("id", "sent_" + messageObject.Id);
                        }


                        var helper = (`@@Helper.ParseContent("${message}")`);
                        console.log(helper);

                        //messageContainer.append(helper);
                        //var message = messageObject.Message.toString();
                        //var parsedContent = '@@Helper.ParseContent("https://www.youtube.com/watch?v=OCceWupZ_Ik&ab_channel=MasterCoding")';
                        //messageContainer.append(parsedContent);
                        //messageContainer.html = parsedContent;

                        messageContainer.append(parsedContent);

                        $(".messagesPanel").append(messageLayout);
                        messageLayout.append(messageContainer);
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log("ERREUR" + errorThrown);
                    console.log("XHR:", xhr);
                    console.log("Erreur:", errorThrown);
                }

            });*/
        }

        function HideFriendBorder() {
            $('.selectedTarget').each(function () {
                $(this).removeClass("selectedTarget");
                $(this).addClass("unselectedTarget");
            });
        }

        function ShowSelectedFriend(name, avatar) {
            var $contentContainer = $("<div>").addClass("avatar-content-container");
            avatar.css("display", "inline-block");
            avatar.css("margin-top", "10px");

            $contentContainer.append(avatar);
            //$contentContainer.append($("<div>").text(" " + name));
            var div = $("<span>").addClass("ellipsis");

            div.text(" " + name);

            $contentContainer.append(div);

            $("#Selected").empty().append("Conversation avec ", $contentContainer);

            $("#message").show();
            $("#send").show();
        }


        $(".unselectedTarget").click(function () {
            HideFriendBorder();

            $(this).addClass("selectedTarget");
            $(this).removeClass("unselectedTarget");

            //update header
            var avatarClone = $(this).find(".UserSmallAvatar").clone();
            avatarClone.removeClass("UserSmallAvatar");
            avatarClone.addClass("UserMediumAvatar");

            var friendName = $(this).attr("title");

            ShowSelectedFriend(friendName, avatarClone);

            //update message panel
            ShowMessages($(".selectedTarget").data("user-id"));

            var userId = $(".selectedTarget").data("user-id");

            //window.location = "@Url.Action("SetMessagedUserId")" + "/" + userId;
        })

        $("#send").click(function () {
            var userId = $(".selectedTarget").data("user-id");

            SendMessage(userId);
            ShowMessages(userId);
        })

        $(document).keydown(function (event) {
            if (event.keyCode === 27) {
                $("#message").val("");
            }
        });

</script>
}